# !/bin/bash

if [ $# -ne 2 ];then
   echo"Le script attend exactement 2 arguments."
   exit
fi

FICHIER_URLS=$1
FICHIER_SORTIE=$2


echo -e '
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/versions/bulma-no-dark-mode.min.css">
  <link rel="stylesheet" href="assets/css/style.css">
  <title>Résultats du mini-projet</title>
</head>

<body>
  <section class="section">
    <div class="container has-background-white ">
      <h1 class="title is-2 has-text-centered mb-5">
        Tableau des résultats
      </h1>
      <div class="container">
        <div class="box">
          <table border="1" class="table is-striped is-hoverable is-fullwidth is-bordered">
            <tr>
              <th class="has-text-centered" >ligne</th>
              <th class="has-text-centered" >code</th>
              <th class="has-text-centered">Url</th>
              <th class="has-text-centered">encodage</th>
              <th class="has-text-centered">aspirations</th>
              <th class="has-text-centered">dumps</th>
              <th class="has-text-centered">compte</th>
              <th class="has-text-centered">contextes</th>
              <th class="has-text-centered">concordances</th>
            <tr>'>$FICHIER_SORTIE

echo $FICHIER_URLS;
basename=$(basename -s .txt $FICHIER_URLS)

ASP_DIR="aspirations/zh"
DUMP_DIR="dumps-text/zh"
CTX_DIR="contextes/zh"
CONC_DIR="concordances/zh"
lineno=1
while read -r URL;
do
    curl -o tmp.txt -k -i -s -L -w "%{content_type}\n%{http_code}" ${URL} > metadata.tmp
    code=$(cat metadata.tmp | tail -n 1)
    encodage=$(cat metadata.tmp | head -n 1 | grep -E -o "charset=.*" | cut -d= -f2)
    if [[ -z "$encodage" ]]; then
        encodage="UTF-8"
    fi
    aspiration=$(curl -s $URL)
    echo "$aspiration" > "$ASP_DIR/$basename-$lineno.html"
    dumpfile="$DUMP_DIR/$basename-$lineno.txt"
    lynx -dump "$ASP_DIR/$basename-$lineno.html" > "$dumpfile"
    MOT="绿"
    compte=$(grep -o "$MOT" "$dumpfile" | wc -l)
    ctxfile="$CTX_DIR/$basename-$lineno.txt"
    grep -n "$MOT" "$dumpfile" > "$ctxfile"
    concfile="$CONC_DIR/$basename-$lineno.html"

    echo "<html><meta charset='UTF-8'><body><table border='1'>" > "$concfile"
    echo "<tr><th>Contexte gauche</th><th>Cible</th><th>Contexte droit</th></tr>" >> "$concfile"

    grep -n "$MOT" "$dumpfile" | while read -r line; do
        txt=$(echo "$line" | cut -d: -f2-)

        left=$(echo "$txt" | sed "s/\(.*\)$MOT.*/\1/")
        right=$(echo "$txt" | sed "s/.*$MOT\(.*\)/\1/")

        echo "<tr><td>$left</td>
                  <td style='color:red;font-weight:bold'>$MOT</td>
                  <td>$right</td></tr>" >> "$concfile"
    done
    echo "</table></body></html>" >> "$concfile"

    echo "<tr>
            <td>$lineno</td>
            <td>$code</td>
            <td><a href=\"$URL\" target=\"_blank\">$URL</a></td>
            <td>$encodage</td>
            <td><a href=\"$ASP_DIR/$basename-$lineno.html\">aspiration</a></td>
            <td><a href=\"$DUMP_DIR/$basename-$lineno.txt\">dump</a></td>
            <td>$compte</td>
            <td><a href=\"$CTX_DIR/$basename-$lineno.txt\">contextes</a></td>
            <td><a href=\"$CONC_DIR/$basename-$lineno.html\">concordance</a></td>
        </tr>" >> "$FICHIER_SORTIE"
    lineno=$((lineno+1))
done < "$FICHIER_URLS"

echo -e "
          </table>
        </div>
      </div>
    </div>
  </section>
</body>
</html>
" >> "$FICHIER_SORTIE"













